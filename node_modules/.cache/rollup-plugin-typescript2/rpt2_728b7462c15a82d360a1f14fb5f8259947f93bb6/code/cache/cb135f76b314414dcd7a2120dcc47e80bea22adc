{"code":"import { isArray, isInteger } from \"../shared/index\";\r\nexport function effect(fn, options) {\r\n    if (options === void 0) { options = {}; }\r\n    var effect = createReactiveEffect(fn, options);\r\n    if (!options.lazy) {\r\n        effect();\r\n    }\r\n    return effect;\r\n}\r\nvar activeEffect; // 用来存储当前的effect函数\r\nvar uid = 0;\r\nvar effectStack = [];\r\nfunction createReactiveEffect(fn, options) {\r\n    var effect = function () {\r\n        // 防止重复更新， 防止递归执行\r\n        if (!effectStack.includes(effect)) {\r\n            try {\r\n                activeEffect = effect;\r\n                effectStack.push(activeEffect);\r\n                return fn(); // 用户自己写的逻辑, 内部会对数据进行取值操作， 在取值的时候， 可以拿到这个activeEffect\r\n            }\r\n            finally {\r\n                effectStack.pop();\r\n                activeEffect = effectStack[effectStack.length - 1];\r\n            }\r\n        }\r\n    };\r\n    effect.id = uid++;\r\n    effect.deps = []; // 用来表示effect中依赖了那些属性\r\n    effect.options = options;\r\n    return effect;\r\n}\r\nvar targetMap = new WeakMap();\r\n// 将属性和effec作一个关联\r\nexport function track(target, key, effect) {\r\n    if (activeEffect === undefined) {\r\n        return;\r\n    }\r\n    // {}\r\n    var depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        // { object: {} }\r\n        targetMap.set(target, (depsMap = new Map()));\r\n    }\r\n    // { object: {a: [effect]} }\r\n    var dep = depsMap.get(key);\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set()));\r\n    }\r\n    if (!dep.has(activeEffect)) { // 如果没有effect， 就把effect放入到集合中\r\n        dep.add(activeEffect);\r\n        activeEffect.deps.push(dep);\r\n    }\r\n    console.log(targetMap);\r\n}\r\n// 触发更新\r\nexport function trigger(target, type, key, value, oldValue) {\r\n    // 判断这个目标有没有收集到依赖\r\n    var depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        return;\r\n    }\r\n    var run = function (effects) {\r\n        if (effects)\r\n            effects.forEach(function (effect) { return effect(); });\r\n    };\r\n    // 数组有特殊的情况\r\n    if (key === 'length' && isArray(target)) {\r\n        depsMap.forEach(function (dep, key) {\r\n            // 如果改的长度小于数组原有的长度， 应该更新试图\r\n            if (key === 'length' || key >= value) {\r\n                run(dep);\r\n            }\r\n        });\r\n    }\r\n    else {\r\n        // 说明修改了key\r\n        if (key !== void 0) {\r\n            // 获取到相应的effect\r\n            run(depsMap.get(key));\r\n        }\r\n        switch (type) {\r\n            case 'add':\r\n                // 给数组通过索引增加选项\r\n                if (isArray(target)) {\r\n                    if (isInteger(key)) {\r\n                        // 如果页面中直接使用了数组， 也会对数组进行取值操作， 会对length进行收集， 新增属性是直接\r\n                        // 触发length即可\r\n                        run(depsMap.get('length'));\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n}\r\n//# sourceMappingURL=effect.js.map","references":["/Users/yueqi/Desktop/code/vue3-source/src/shared/index.ts"],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/reactivity/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
